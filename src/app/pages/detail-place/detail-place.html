<main class="page">
  <div class="container py-5" *ngIf="place">
    <!-- Botón de navegación -->
    <div class="mb-4">
      <button type="button" class="btn btn-outline-secondary" (click)="goBack()">
        <span class="material-symbols-rounded me-2">arrow_back</span>
        Volver a mis alojamientos
      </button>
    </div>

    <!-- Título y precio -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-start flex-wrap">
          <div>
            <h1 class="display-5 fw-bold mb-2">{{ place.title }}</h1>
            <div class="d-flex align-items-center mb-3">
              <!-- Rating con estrellas -->
              <div class="rating-stars me-2">
                <span *ngFor="let star of getStars(place.averageRating)"
                      class="material-symbols-rounded star"
                      [class.filled]="star === 1"
                      [class.half]="star === 0.5">
                  {{ star === 0.5 ? 'star_half' : 'star' }}
                </span>
              </div>
              <span class="fw-semibold">{{ place.averageRating }}/5</span>
            </div>
          </div>
          <div class="text-end">
            <div class="h2 text-primary fw-bold mb-0">
              {{ place.price | currency:'COP':'symbol':'1.0-0' }}
            </div>
            <small class="text-muted">por noche</small>
            <button type="button" class="btn btn-primary mt-3" (click)="navigateToBooking()">
              <span class="material-symbols-rounded me-2">event_available</span>
              Reserva
            </button>
            <button type="button" class="btn btn-outline-danger mt-3 ms-2" (click)="addToFavorites()">
              <span class="material-symbols-rounded me-2">favorite_border</span>
              Agregar a favoritos
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Galería de imágenes -->
    <div class="row mb-5">
      <div class="col-12">
        <div class="image-gallery">
          <div class="main-image-container">
            <img [src]="place.picsUrl[currentImageIndex]"
                 [alt]="place.title"
                 class="main-image img-fluid rounded"
                 loading="lazy">

            <!-- Controles del carrusel -->
            <button class="carousel-control prev" (click)="prevImage()" *ngIf="place.picsUrl.length > 1">
              <span class="material-symbols-rounded">chevron_left</span>
            </button>
            <button class="carousel-control next" (click)="nextImage()" *ngIf="place.picsUrl.length > 1">
              <span class="material-symbols-rounded">chevron_right</span>
            </button>
          </div>

          <!-- Miniaturas -->
          <div class="thumbnails" *ngIf="place.picsUrl.length > 1">
            <div class="thumbnail-item"
                 *ngFor="let image of place.picsUrl; let i = index"
                 [class.active]="i === currentImageIndex"
                 (click)="goToImage(i)">
              <img [src]="image" [alt]="'Imagen ' + (i + 1)" class="thumbnail-image">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido principal -->
    <div class="row">
      <!-- Información principal -->
      <div class="col-lg-8 mb-4">
        <!-- Descripción -->
        <div class="card mb-4">
          <div class="card-body">
            <h3 class="card-title mb-3">Descripción</h3>
            <p class="card-text">{{ place.description }}</p>
          </div>
        </div>

        <!-- Comodidades -->
        <div class="card mb-4">
          <div class="card-body">
            <h3 class="card-title mb-3">Comodidades</h3>
            <div class="amenities-grid">
              <div class="amenity-item" *ngFor="let amenity of place.amenities">
                <span class="material-symbols-rounded amenity-icon">check_circle</span>
                <span class="amenity-text">{{ getAmenityLabel(amenity) }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Detalles adicionales -->
        <div class="card">
          <div class="card-body">
            <h3 class="card-title mb-3">Detalles del alojamiento</h3>
            <div class="details-grid">
              <div class="detail-item">
                <span class="material-symbols-rounded detail-icon">group</span>
                <div>
                  <div class="fw-semibold">Capacidad</div>
                  <small class="text-muted">{{ place.capacity }} personas</small>
                </div>
              </div>
              <div class="detail-item">
                <span class="material-symbols-rounded detail-icon">location_on</span>
                <div>
                  <div class="fw-semibold">Ubicación</div>
                  <small class="text-muted">{{ place.latitude }}, {{ place.longitude }}</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Información del propietario y Reserva -->
      <div class="col-lg-4">
        <!-- Información del propietario -->
        <div class="card">
          <div class="card-body">
            <h4 class="card-title mb-3">Propietario</h4>
            <div class="host-info">
              <div class="host-avatar mb-3">
                <img [src]="place.userDetailDTO.photoUrl || '/assets/img/fallback.svg'"
                     [alt]="place.userDetailDTO.name"
                     class="host-image rounded-circle">
              </div>
              <h5 class="host-name mb-2">{{ place.userDetailDTO.name }}</h5>
              <div class="host-details">
                <div class="mb-2">
                  <span class="material-symbols-rounded me-2">person</span>
                  <small>ID: {{ place.userDetailDTO.id }}</small>
                </div>
                <div class="mb-2">
                  <span class="material-symbols-rounded me-2">calendar_today</span>
                  <small>Miembro desde: {{ place.userDetailDTO.createdAt | date:'mediumDate' }}</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Formulario de Reserva -->
        <div class="mt-2" *ngIf="place">
          <app-booking-form [accommodationId]="placeId"></app-booking-form>
        </div>
      </div>
    </div>

    <!-- Sección de Comentarios -->
    <div class="row mt-5">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <h3 class="card-title mb-4">Comentarios</h3>

            <!-- Formulario para crear comentario -->
            <div class="comment-form mb-4" *ngIf="canComment">
              <h5>Deja tu comentario</h5>
              <form [formGroup]="commentForm" (ngSubmit)="createComment()" class="mt-3">
                <div class="mb-3">
                  <label for="rating" class="form-label">Calificación</label>
                  <select id="rating" class="form-select" formControlName="rating">
                    <option value="5">⭐⭐⭐⭐⭐ (5 estrellas)</option>
                    <option value="4">⭐⭐⭐⭐ (4 estrellas)</option>
                    <option value="3">⭐⭐⭐ (3 estrellas)</option>
                    <option value="2">⭐⭐ (2 estrellas)</option>
                    <option value="1">⭐ (1 estrella)</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="comment" class="form-label">Comentario</label>
                  <textarea id="comment" class="form-control" rows="3" formControlName="comment"
                           placeholder="Comparte tu experiencia en este alojamiento..."></textarea>
                  <div class="form-text">{{ commentForm.get('comment')?.value?.length || 0 }}/1000 caracteres</div>
                </div>
                <button type="submit" class="btn btn-primary" [disabled]="commentForm.invalid">
                  Publicar comentario
                </button>
              </form>
            </div>

            <!-- Lista de comentarios -->
            <div class="comments-list">
              <div *ngIf="comments.length === 0" class="text-center py-4">
                <p class="text-muted">Aún no hay comentarios para este alojamiento.</p>
              </div>

              <div class="row">
                <div *ngFor="let comment of comments" class="col-lg-6 col-md-12 mb-4">
                  <div class="comment-card">
                    <div class="comment-header d-flex align-items-start">
                      <img [src]="comment.userDetailDTO.photoUrl || '/assets/img/fallback.svg'"
                           [alt]="comment.userDetailDTO.name"
                           class="comment-avatar rounded-circle me-3">
                      <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start">
                          <div>
                            <h6 class="comment-author mb-1">{{ comment.userDetailDTO.name }}</h6>
                            <div class="rating-stars mb-2">
                              <span *ngFor="let star of getStars(comment.rating)"
                                    class="material-symbols-rounded star"
                                    [class.filled]="star === 1"
                                    [class.half]="star === 0.5">
                                {{ star === 0.5 ? 'star_half' : 'star' }}
                              </span>
                              <span class="rating-text ms-2">{{ comment.rating }}/5</span>
                            </div>
                          </div>
                          <small class="text-muted comment-date">{{ comment.createdAt | date:'mediumDate' }}</small>
                        </div>
                        <div class="comment-content">
                          <p class="mb-0">{{ comment.comment }}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Paginación -->
              <nav *ngIf="totalPages > 1" class="mt-4">
                <ul class="pagination justify-content-center">
                  <li class="page-item" [class.disabled]="currentPage === 0">
                    <a class="page-link" (click)="changePage(currentPage - 1)" aria-label="Anterior">
                      <span aria-hidden="true">&laquo;</span>
                    </a>
                  </li>
                  <li class="page-item" *ngFor="let page of getVisiblePages(); let i = index"
                      [class.active]="page === currentPage">
                    <a class="page-link" (click)="changePage(page)">{{ page + 1 }}</a>
                  </li>
                  <li class="page-item" [class.disabled]="currentPage === totalPages - 1">
                    <a class="page-link" (click)="changePage(currentPage + 1)" aria-label="Siguiente">
                      <span aria-hidden="true">&raquo;</span>
                    </a>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading state -->
  <div class="container py-5 text-center" *ngIf="!place">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-3">Cargando detalles del alojamiento...</p>
  </div>
</main>
